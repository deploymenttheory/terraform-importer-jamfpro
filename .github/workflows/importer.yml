name: Importer

on:
    workflow_dispatch:

jobs:
    importer:
        name: "Import-Run"
        runs-on: ubuntu-latest
        environment: importer-lbgsandbox
        env:
            JAMFTF_JPRO_TENANT_ID: ${{ vars.JAMFTF_JPRO_TENANT_ID }}
            JPRO_CLIENT_ID: ${{ secrets.JPRO_CLIENT_ID }}
            JPRO_CLIENT_SECRET: ${{ secrets.JPRO_CLIENT_SECRET }}
            JAMFTF_CONFIG_FP: ${{ vars.JAMFTF_CONFIG_FP }}
            JAMFTF_OUTPUT_DIR: ${{ vars.JAMFTF_OUTPUT_DIR }}
            JAMFTF_DEBUG_MODE: True
            
        steps:
            - name: "Checkout"
              uses: actions/checkout@v4.1.1

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.x'

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install git+https://github.com/thejoeker12/jamfpy@v1.1.1
                pip install git+https://${{ secrets.PAT_TOKEN }}@github.com/deploymenttheory/jamftf-python-terraform-importer@v0.2.1
                pip install -r scripts/requirements.txt

            - name: Run Python script
              run: python scripts/import_via_config_file.py


            - name: Install Terraform
              uses: hashicorp/setup-terraform@v3.1.2
              with:
                terraform_version: latest

            - name: Install Terraform and run FMT
              run: |
                cd importer_working_dir/outputs
                terraform fmt
              
            - name: Commit back to Repo
              run: |
                git config --global user.email "action@github.com"
                git config --global user.name "Github Action"
                git add importer_working_dir/outputs
                git commit -m "Uploading output files"
                git push